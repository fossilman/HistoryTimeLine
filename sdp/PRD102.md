# History Timezone
## 产品需求文档（PRD · MVP 版本 v1.2）

---

## 一、产品概述

### 1. 产品定位
**History Timezone** 是一个以「时间轴」为核心的历史可视化产品,帮助用户直观理解不同时代、不同文明、不同政权在时间维度上的存在与重叠关系。

本版本为 **MVP(最小可行产品)**,目标是:
* 验证无极缩放时间轴模型的交互体验
* 建立稳定的历史数据结构(文明-政权-人物-事件)
* 为后续扩展(AI分析、关系图谱)打下基础

---

### 2. 产品目标
* 提供一个**真正无极缩放的历史时间轴**(完全连续,无预设级别)
* 清晰展示:
  * 文明的时间范围
  * 政权的兴衰更替
  * 历史人物的生命周期
  * 历史事件的发生节点
* 根据缩放比例智能显示不同密度的信息
* 保证结构清晰、信息准确、可持续扩展

---

## 二、核心用户与使用场景

### 目标用户
* 历史爱好者
* 学生 / 教师
* 内容创作者(历史类视频 / 写作者)
* 对世界历史结构感兴趣的普通用户

### 核心使用场景
1. 快速了解某一文明的历史脉络
2. 对比同一时期不同政权的存在情况
3. 查看历史人物的生平时间与所处时代
4. 查阅某个历史事件在时间轴中的位置
5. 通过自由缩放发现不同时间尺度下的历史规律

---

## 三、核心概念定义

### 1️⃣ 文明(Civilization)
* 时间跨度最长(数千年)
* 作为**背景层**
* 不直接承载事件

**示例**: 华夏文明、欧洲文明

---

### 2️⃣ 政权(Polity)
* 文明下的具体政治实体
* 有明确起止时间
* 是事件和人物的主要归属单位

**示例**: 汉、唐、罗马帝国

---

### 3️⃣ 人物(Person)
* 以**时间区间**呈现(出生年-逝世年)
* 归属于特定政权/文明
* 在精细缩放下成为主要展示内容

**示例**:
* 秦始皇(前259-前210)
* 凯撒(前100-前44)

**设计理念**: 在精细缩放级别下,绝大部分事件是瞬时的,而人物作为时间区间能够提供更丰富的时间维度信息。

---

### 4️⃣ 事件(Event)
事件分为两种:

#### A. 持续型事件(Duration Event)
* 有起止时间
* 如战争、改革、运动

#### B. 瞬时事件(Point Event)
* 单一年份发生
* 如建国、条约签订、重大发现
* **在精细缩放下占主导**

---

## 四、功能需求

### 4.1 无极缩放时间轴系统 **[UPDATED]**

#### 功能描述
* 横向时间轴,支持**完全连续的无极缩放**
* **鼠标滚轮控制缩放**: 向上滚动放大,向下滚动缩小
* 缩放中心点为鼠标指针位置(类似地图应用)
* 支持左右拖动浏览
* **实时显示当前时间跨度比例尺**

#### 缩放机制
* **无预设级别**: 缩放完全连续,可以停留在任意缩放比例
* **缩放范围**: 
  - 最小: 视窗显示 10,000+ 年(宏观历史全景)
  - 最大: 视窗显示 5-10 年(精细到年份级别)
* **缩放速度**: 每次滚轮滚动改变 10-15% 的缩放比例
* **平滑过渡**: 缩放和拖动均带有流畅动画

#### 内容显示规则(基于视窗跨度)

| 视窗时间跨度 | 显示内容 | 信息密度 |
|-------------|---------|---------|
| **> 2000年** | 文明背景层 + 存续超过200年的主要政权 | 极简 |
| **500-2000年** | 文明 + 所有政权条带 | 简略 |
| **100-500年** | 政权 + 重大持续型事件(战争/改革) | 中等 |
| **30-100年** | 政权 + 持续事件 + 核心历史人物 | 丰富 |
| **< 30年** | 所有内容(人物生命区间 + 所有事件点) | 详尽 |

#### 交互规则
* 时间从左到右递增
* 滚轮缩放时保持鼠标指针对应的年份位置不变
* 鼠标拖动时支持惯性滚动(可选)
* 双击某个元素自动缩放并聚焦到该元素
* 比例尺实时更新并显示在界面固定位置

---

### 4.2 文明展示(背景层)

* 以横向色带形式呈现
* 覆盖其存在的时间范围
* 位于所有内容的最底层
* **显示规则**: 在所有缩放级别均可见,但透明度随缩放调整
* 可折叠/高亮(非必须)

---

### 4.3 政权展示(核心层)

* 政权以横向条带形式呈现
* 位于所属文明之上
* 显示起止时间
* **智能布局规则**: 
  - 当多个政权的时间有重叠时,分配到不同的横向轨道(track)
  - 当政权时间不重叠时,共用同一条轨道,节省垂直空间
  - 同一文明内的政权优先在相邻轨道排列
* **显示规则**: 
  - 视窗跨度 > 2000年: 仅显示存续超过200年的政权
  - 视窗跨度 < 2000年: 显示所有政权
  - 政权条宽度随缩放比例自适应

**布局算法示例**:
```
轨道1: 秦(-221~-206) → 汉(-202~220) → 晋(265~420) → 隋(581~618)
轨道2: 三国(220~280) → 南北朝(420~589) → 唐(618~907)
轨道3: 宋(960~1279) → 明(1368~1644)
轨道4: 元(1271~1368) → 清(1644~1911)
```
注意: 元(1271)与宋(1279)有重叠,所以分配到不同轨道

---

### 4.4 人物展示

#### 显示形式
* 横向时间区间条(生卒年)
* 位于政权层之上
* 颜色/样式与所属政权关联

#### 智能布局规则
* **轨道分配**: 与政权相同的智能布局算法
  - 生命周期有重叠的人物分配到不同轨道
  - 生命周期不重叠的人物共用同一轨道
  - 最大化垂直空间利用率

#### 显示规则
* **视窗跨度 < 100年**: 显示核心人物(帝王、重要政治家/思想家)
* **视窗跨度 < 30年**: 显示所有已录入人物
* 人物条高度随缩放比例调整

#### 交互
* 悬停: 显示姓名、生卒年、主要身份
* 点击: 展示详细信息卡片(生平简介、关键事件)
* 双击: 缩放并聚焦到该人物的生命周期

---

### 4.5 事件展示

#### 事件类型与表现

| 类型 | 表现形式 | 显示时机 |
|-----|---------|---------|
| 持续型 | 横向半透明条带 | 视窗跨度 < 500年 |
| 瞬时型 | 垂直标记点 | 视窗跨度 < 30年 |

#### 智能布局规则
* **持续型事件**: 应用与政权/人物相同的轨道分配算法
  - 时间重叠的事件分配到不同轨道
  - 时间不重叠的事件共用轨道
* **瞬时型事件**: 
  - 使用散点布局
  - 密集区域自动调整垂直位置避免重叠
  - 过于密集时可聚合显示数量

#### 显示规则
* 持续型事件的透明度和高度随缩放调整
* 事件优先级: 重大事件 > 普通事件

#### 交互
* 悬停: 显示简要信息
* 点击: 展示完整信息卡片
* 双击: 缩放并聚焦到该事件

---

### 4.6 动态比例尺显示

#### 位置
* 固定在时间轴顶部
* 始终可见,不随滚动消失

#### 显示内容
* **动态比例尺**: "1cm ≈ X年" (实时计算)
  - 视窗跨度 > 1000年: "1cm ≈ 500年"
  - 视窗跨度 100-1000年: "1cm ≈ 50年"
  - 视窗跨度 < 100年: "1cm ≈ 5年"
* **当前视窗范围**: "公元前 500年 - 公元 200年"
* **总时间跨度**: "(共 700年)"

#### 样式
* 类似地图比例尺的刻度线设计
* 随缩放比例自动调整刻度密度
* 清晰易读,不干扰主内容

---

### 4.7 键盘快捷键(可选)

* `+` / `-`: 缩放
* `←` / `→`: 左右平移
* `Space`: 暂停/恢复惯性滚动
* `Home`: 跳转到时间轴起点
* `End`: 跳转到时间轴终点

---

## 五、数据结构(MVP)

### Civilization
```json
{
  "id": "sinitic",
  "name": "华夏文明",
  "startYear": -2000,
  "endYear": null,
  "color": "#FFA500"
}
```

### Polity
```json
{
  "id": "han",
  "name": "汉",
  "civilizationId": "sinitic",
  "startYear": -202,
  "endYear": 220,
  "color": "#FF6347",
  "importance": "high"
}
```

### Person
```json
{
  "id": "qin_shi_huang",
  "name": "秦始皇(嬴政)",
  "birthYear": -259,
  "deathYear": -210,
  "polityId": "qin",
  "importance": "high",
  "title": "皇帝",
  "briefIntro": "中国历史上首位皇帝,统一六国"
}
```

### Event
```json
{
  "id": "qin_unification",
  "name": "秦统一六国",
  "type": "point",
  "year": -221,
  "relatedPolities": ["qin"],
  "relatedPersons": ["qin_shi_huang"],
  "description": "秦王嬴政完成统一大业",
  "importance": "high"
}
```

**持续型事件示例**:
```json
{
  "id": "warring_states",
  "name": "战国时期",
  "type": "duration",
  "startYear": -475,
  "endYear": -221,
  "relatedPolities": ["qin", "chu", "yan", "han", "zhao", "wei", "qi"],
  "importance": "high"
}
```

---

## 六、界面结构示意

```
┌──────────────────────────────────────────┐
│ 工具栏(时间跳转 / 搜索 / 设置)           │
├──────────────────────────────────────────┤
│ 比例尺 [1cm ≈ 50年] [前500 - 200年]      │
│ ├─────┼─────┼─────┼─────┼────           │
├──────────────────────────────────────────┤
│                                          │
│ 文明背景层(淡色区域)                    │
│  ┌────────────────────────────────────┐ │
│  │ 政权轨道(智能布局,避免重叠)         │ │
│  │   轨道1: ─ 秦 ─→─ 汉 ──────────── │ │
│  │   轨道2: ───────── 三国 ─→─ 晋 ── │ │
│  │   轨道3: ─────────────────→─ 唐 ─ │ │
│  │                                     │ │
│  │ 人物轨道(智能布局)                  │ │
│  │   轨道1: ─ 人物1 ─→─ 人物3 ──────  │ │
│  │   轨道2: ───── 人物2 ─→─ 人物4 ─   │ │
│  │                                     │ │
│  │ 事件层: ● ● ● (散点布局)           │ │
│  └────────────────────────────────────┘ │
│                                          │
│   [滚轮缩放提示: 滚动以缩放时间轴]       │
├──────────────────────────────────────────┤
│ 详情面板(人物/事件信息卡片)             │
└──────────────────────────────────────────┘
```

---

## 七、技术考虑

### 7.1 性能优化
* **虚拟化渲染**: 仅渲染当前视窗内的元素
* **动态LOD(细节层次)**: 根据视窗跨度实时计算并显示对应密度的数据
* **懒加载**: 人物和事件数据按需加载
* **Canvas渲染**: 使用Canvas而非DOM元素提升大量图形渲染性能

### 7.2 缩放实现
* 使用 **Canvas 或 WebGL** 实现连续缩放
* 参考 D3.js 的 zoom behavior 或自行实现缩放矩阵
* **缩放算法**: 
  ```
  新缩放比例 = 当前缩放比例 × (1 + 滚轮增量 × 0.001)
  视窗年数 = 基准年数 / 缩放比例
  ```
* **平滑过渡**: 使用 `requestAnimationFrame` 实现 60fps 动画

### 7.3 交互实现
* **滚轮事件**: 监听 `wheel` 事件,计算缩放增量
* **拖动事件**: 监听 `mousedown` / `mousemove` / `mouseup`
* **缩放中心点计算**: 
  ```
  鼠标对应年份 = 起始年份 + (鼠标X / 视窗宽度) × 视窗年数
  缩放后保持该年份在鼠标位置不变
  ```

### 7.4 数据管理与布局算法

#### 时间索引
* 按年份建立B树索引加速范围查询
* 按视窗跨度分级存储数据(类似四叉树)

#### 关系索引
* 政权-人物、人物-事件的关联关系

#### 轨道分配算法(Track Assignment Algorithm)

用于政权、人物、持续型事件的智能布局:

```javascript
function assignTracks(items) {
  // 按开始时间排序
  items.sort((a, b) => a.start - b.start);
  
  const tracks = []; // 每条轨道存储已占用的时间段
  const assignments = {}; // 记录每个元素分配到的轨道
  
  for (const item of items) {
    // 寻找第一个不冲突的轨道
    let trackIndex = 0;
    while (trackIndex < tracks.length) {
      const track = tracks[trackIndex];
      // 检查是否与该轨道最后一个元素有重叠
      if (track.end <= item.start) {
        // 无重叠,可以使用此轨道
        track.end = item.end;
        break;
      }
      trackIndex++;
    }
    
    // 如果所有轨道都冲突,创建新轨道
    if (trackIndex === tracks.length) {
      tracks.push({ end: item.end });
    }
    
    assignments[item.id] = trackIndex;
  }
  
  return assignments;
}
```

**算法特点**:
- 时间复杂度: O(n × m), n为元素数量, m为轨道数量
- 空间复杂度: O(n)
- 贪心策略: 总是选择第一个可用轨道
- 保证时间不重叠的元素共用轨道,最小化垂直空间

---

## 八、MVP 范围界定

### ✅ 包含功能
* 完全无极缩放时间轴(滚轮控制)
* 动态比例尺实时更新
* 文明、政权、人物、事件的分层展示
* 基于视窗跨度的智能内容过滤
* 点击查看详情
* 至少覆盖 2-3 个文明的核心数据

### ❌ 不包含功能
* 预设缩放级别按钮(完全由滚轮控制)
* 多维度筛选(地理、类型)
* AI 生成内容
* 用户自定义时间轴
* 社交分享功能
* 键盘快捷键(可后续迭代)

---

## 九、后续迭代方向

1. **性能优化**: WebGL 渲染、Web Worker 数据处理
2. **关系图谱**: 人物-事件-政权的网络关系可视化
3. **地理维度**: 结合地图展示政权疆域变化
4. **AI 辅助**: 自动生成历史总结、关联推荐
5. **协作功能**: 用户贡献内容、社区审核

---

## 十、验收标准

1. ✅ 时间轴支持流畅的无极缩放(60fps)
2. ✅ 滚轮缩放响应灵敏,缩放中心点计算准确
3. ✅ 比例尺实时更新且准确
4. ✅ 不同视窗跨度正确显示/隐藏对应内容
5. ✅ 人物时间区间与政权时间轴正确对齐
6. ✅ 点击人物/事件能正确显示详情卡片
7. ✅ 缩放和拖动无明显卡顿或延迟
8. ✅ 至少录入 50 个政权、200 个人物、100 个事件

---

## 十一、交互设计细节

### 11.1 滚轮缩放反馈
* 缩放时显示半透明提示: "视窗: 500年"
* 提示 1 秒后自动消失
* 缩放到极限时显示边界提示

### 11.2 拖动反馈
* 拖动时光标变为抓手状态
* 支持边界弹性效果(拖到时间轴边缘时有回弹)

### 11.3 加载状态
* 初次加载显示骨架屏
* 数据懒加载时显示 loading 指示器

---

**文档版本**: v1.2  
**更新日期**: 2025-12-31  
**主要变更**: 
- 移除预设缩放级别,改为完全连续的无极缩放
- 新增滚轮控制缩放机制
- 明确基于视窗跨度的动态内容显示规则
- 补充缩放中心点计算逻辑
- **新增智能轨道分配算法,避免元素重叠并最大化空间利用率**